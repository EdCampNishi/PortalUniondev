
@{
    ViewBag.Title = "AgendaConsulta";
    //Layout = "~/Views/Cliente/LayoutContaCliente.cshtml";

}

<style>
    .modal-body {
        max-height: calc(100h - 250px);
        overflow-y: auto;
    }

    .input-group {
        margin-top: 10px;
    }
</style>
<div>

    <script data-require="jquery" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script data-require="moment.js" data-semver="2.14.1" src="https://npmcdn.com/moment@2.14.1"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.0/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.0/locale/pt-br.js"></script>
    @*<script src="~/js/calendar.js"></script>*@
    <link rel="stylesheet" href="~/styles/bootstrap.css" />
    <script src="/js/bootstrap.min.js"></script>
    @*<script src="/js/bootstrap-switch.min.js"></script>*@
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.3.0/fullcalendar.min.css" />
    <link rel="stylesheet" href="~/styles/calendar.css" />

    <div class="col-md-8">
        <div id="calendar"></div>
        @*<div class="background"></div>*@
    </div>



    <div id="modalCalendario" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>


                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="box box-solid">
                                <div class="box-header with-border">
                                    <h3 class="box-title">Cadastrar Horário</h3>

                                </div>

                                <div class="box-body">




                                    <div class="form-group">
                                        <label class="control-label col-sm-2 ">Objetivo</label>

                                        <div class="col-sm-6">
                                            <input type="hidden" id="hddAgendamento" />
                                            <input type="hidden" id="data" name="data" />
                                            <input type="text" value="" name="objetivo" id="objetivo" class="form-control text-body" data-val="true" />
                                            <span class="field-validation-valid help-block position-absolute" data-valmsg-replace="true" data-valmsg-for="objetivo"></span>

                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="control-label col-sm-2 ">Nome</label>

                                        <div class="col-sm-6">
                                            <input type="text" value="" name="nome" id="nome" class="form-control text-body" data-val="true" />
                                            <span class="field-validation-valid help-block position-absolute" data-valmsg-replace="true" data-valmsg-for="nome"></span>

                                        </div>
                                    </div>


                                    <div class="form-group">
                                        <label class="control-label col-sm-2 ">Horários</label>
                                        <ul>
                                            @*@foreach(var horas in horariosDisponiveis)
                                            {

                                            }*@
                                            <li><a class="btn" name="horarios"></a></li>
                                        </ul>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-default pull-left" data-dismiss="modal">Fechar</a>
                    <button class="btn btn-default pull-right" onclick="Salvar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    //Executa assim que carrega a página
    $(document).ready(function () {
        // Fetch our events
        var agenda = [];

        //Envia uma requisição para Consultar todos Eventos cadastrados
        $.ajax({
            url: '@Url.Action("ConsultaAgendaGeral", "Cliente")',
            type: 'GET',
            success: function (data) {
                agenda = JSON.parse(data);

                $('#calendar').fullCalendar({

                    //Traduz para o Portugues Br
                    lang: 'pt-br',
                    //Mostra os Eventos Agendado em Tela 
                    events: agenda,

                    //Evento ao clicar sobre a data
                    dayClick: function (date, jsEvent, view) {
                        date = date.format()
                        var now = new Date();
                        var today = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate();

                        if (Date.parse(date) > Date.parse(today)) {

                            //Verifica com o metodo ValidaEventosPorDia. Se existir mais do que 3 eventos, não pode marcar outro.
                            if (ValidaEventosPorDia(date) == "ok") {

                                $("#horarios").val()

                                //Abre modal para inserção de dados
                                $("#modalCalendario").modal({
                                    backdrop: 'static'
                                }, 'show');
                                $('#data').val(date)
                                $('.modalCalendario').show()
                                $('.background').show()

                            }
                            else {
                               
                                alert("Não é mais possível marcar consulta nesta data.");
                            }
                        }
                    }
                });

                $('.background').click(function () {

                    $('#form').hide()
                    $('.background').hide()
                })
            }
        });
    });


    function ValidaEventosPorDia(data) {
        var retorno = $.ajax({
            url: '@Url.Action("ValidaQuantidadeConsultaPorDia", "Cliente")',
            type: 'GET',
            dataType: 'json',
            async: false,
            data: { date: data }
        });

        return retorno.responseText;
    };


    //Salvaa consulta em Banco
    function Salvar() {
        var cod = $("hddAgendamento").val();
        var objetivo = $('#objetivo').val();
        var nome = $('#nome').val();
        var inicio = $('#horarios').val();
        var fim = "18:00"
        var date = $('#data').val();

        $.ajax({
            url: "@Url.Action("CriarAgendamento", "Cliente")",
            type: "POST",
            dataType: "json",
            data: { Codigo: cod, Objetivo: objetivo, NomeCandidato: nome, HoraInicio: inicio, HoraFim: fim, Data: date },
            success: function (dados) {
                var agendamento = JSON.parse(dados);
                console.log(agendamento);
            }
        });
    };



</script>

